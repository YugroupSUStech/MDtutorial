分子对接就是两个或多个分子之间通过几何匹配和能量匹配相互识别找到最佳匹配模式的过程，在酶学研究和药物设计中应用非常广泛。分子对接计算是在受体活性位点区域通过空间结构互补和能量最小化原则来搜寻配体与受体是否能产生相互作用以及它们之间的最佳结合模式。分子对接的思想起源于**Fisher**的“*锁钥模型*”，主要强调的是空间形状的匹配。但配体和受体的识别要比这个模型更加复杂。首先，配体和受体在对接过程中会由于相互适应而产生构象的变化。其次，分子对接还要求能量匹配，对接过程中结合自由能的变化决定了两个分子是否能够结合以及结合的强度。

## Docking的理论背景

分子对接的目的是找到底物分子和受体分子最佳结合位置及其结合强度，最终可以获得配体和受体的结合构象，但这样的构象可以有很多，一般认为自由能最小的构象存在的概率最高。所以Docking可以分为两部分：构象搜索和打分函数。通常使用的构象搜索方法有：分子动力学方法、随机搜索、遗传算法、距离几何算法等，随机搜索又包括完全随机算法、蒙特卡罗法和模拟退火法等；而打分函数是针对搜索到的构象计算底物分子和受体分子间的结合自由能，不同软件的打分函数可能由于针对不同的研究体系有所差异。因此在使用docking前，应针对自己的体系选择合适的docking软件。

现阶段有许多软件和在线服务器可以实现分子对接，对于所研究的不同体系应选择适当的软件，本教程主要针对蛋白-小分子配体对接，主要介绍[Autodock Suite](https://ccsb.scripps.edu/projects/docking/)的使用方法。一些其他的docking方法包括：
* [leDock](http://www.lephar.com/software.htm) 非常快速的Protein-Ligand对接软件，据说结果比Autodock和Vina都更准确
* [Zdock](https://zdock.umassmed.edu/) 两个刚性蛋白对接的在线服务器
* [rDock](http://rdock.sourceforge.net/) 适用于核酸体系的分子对接软件
* [HADDOCK](http://milou.science.uu.nl/) 信息驱动的蛋白-蛋白/蛋白-核酸对接的在线服务器

分子对接方法根据不同的简化程度分为三类：刚性对接、半柔性对接和柔性对接。刚性对接指在对接过程中，受体和配体的构象不发生变化，适合研究比较大的体系如蛋白-蛋白之间以及蛋白-核酸之间，计算简单，主要考虑对象之间的契合程度。半柔性对接常用于小分子和大分子的对接，在对接过程中，小分子的构象可以在一定范围内变化，但大分子是刚性的。这样既可以在一定程度上考察柔性的影响，又能保持较高的计算效率。在药物设计和虚拟筛选过程中一般采用半柔性的分子对接方法。柔性对接方法一般用于精确研究分子之间的识别情况，由于允许对接体系的构象变化，可以提高对接准确性但耗时较长。

## Autodock软件安装

当前的 AutoDock 发行版包含两代软件：AutoDock 4 和 AutoDock Vina。根据自己的操作系统，可从官网下载 (https://autodock.scripps.edu/) 不同版本。另外，也已经开发了 AutoDock-GPU，它是 AutoDock4 的GPU加速版本，比原来的单 CPU 对接代码快数百倍。AutoDock 4 实际上由两个主要程序组成：***autogrid*** 会预先计算这些网格；***autodock*** 执行配体与一组描述目标蛋白的网格的对接。

AutoDock Vina 不需要为它们选择原子类型和预先计算网格图。相反，它会在内部为所需的原子类型计算网格，并且几乎立即执行此操作。除此之外，也开发了一个名为 AutoDockTools 或简称 ADT 的图形用户界面，它有助于设置哪些键在配体中被视为可旋转并方便地分析对接。下面我们先介绍win10环境下Autodock和图形界面ADT的安装和使用：（也推荐在Linux下安装，使用命令行）

### step1. 下载主程序软件包

选择Windows版本并下载

![dock1](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/autodockwin.png)

下载后选择合适的磁盘安装，安装后的文件夹包括***autogrid***和***autodock***两个程序。

### step2. 下载图形界面ADT

可从[MGLTools官网](https://ccsb.scripps.edu/mgltools/downloads/)下载最新的**V1.5.7**版本，如下：

![ADT](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/adttools.png)

下载后选择合适的磁盘安装，安装后的文件夹也包括***openbabel***，用来转化文件格式很好用。另外可以先浏览[/pdfs](https://github.com/YugroupSUStech/MDtutorial/tree/main/pdfs)中的`2012_ADTtut`教程熟悉一下ADT的图形界面，按照教程自己实际操作一遍，理解工具栏每个按钮大概的功能。

### step3. 设置工作路径

可以先通过下图设置优先的工作路径，这样在每次用GUI界面选取文件时可以更方便快捷地定位到工作路径。（注意工作路径中不要出现中文）

![path](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/setpath.png)

### step4. 选择受体文件

设定好路径之后，我们正式开始分子对接的流程，主要包括准备受体pdb->除去水分子离子并加氢原子->计算原子电荷->设置刚性/柔性区域->保存为受体pdbqt格式文件，准备配体pdb文件->加氢原子->计算原子电荷->设置扭转数->保存为配体pdbqt文件，设置对接的gridbox大小和位置->计算原子探针的gridmap，设置构象搜索方法和其他参数->执行autodock4进行对接。以上步骤可以通过GUI界面或者命令行进行准备，但在设置GridBox时最后在GUI进行，方便观察。下面我们以HIV-1蛋白酶（PDB ID: 1HSG）及其药物抑制剂印地那韦（indinavir）为例进行docking介绍。

* 从[蛋白pdb数据库](https://www.rcsb.org/)下载**1HSG**的pdb文件，如图：

![1hsg](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/1hsg.png)

* 下载后的复合物可以先手动删掉配体分子，只保留蛋白分子，或者在linux下通过以下命令提取蛋白。然后双击打开ADTools，按照下图依次点击，加载蛋白分子。
```
egrep "^(ATOM|TER)" 1hsg.pdb >1hsg_prot.pdb
```
![jiazai](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/load.png)

* 再依次点击以下按钮，除去水分子：

![delwat](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/delwat.png)

* 加氢原子，选择`All Hydrogens` or `Polar Only`都可，对结果不影响，因为pdbqt中只保留极性氢原子。

![addH](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/addH.png)

![allorpolar](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/allorpolar.png)

* 计算原子电荷，选择Kollman电荷或者Gasteiger电荷都可以，默认计算Gasteiger电荷。

![charge](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/charge.png)

* 选择刚性/柔性残基，到这里一般执行半柔性对接即可，即蛋白受体设置为刚性，配体设置为柔性。若设为刚性受体，则依次点击以下按钮，再依次点击“**Grid**”→“**Macromolecule**”→“**Choose**”→“**Select Molecule**”，最后保存为`1hsg.pdbqt`文件。（若出现报错信息，请检查保存文件的工作路径是否存在1hsg.pdb）

![rigid](https://github.com/YugroupSUStech/MDtutorial/blob/main/IMG/rigid.png)

若需要设置柔性残基，则按照以下按钮选择需要设置的残基：

在得到`1hsg.pdbqt`基础上，继续依次点击工具栏“**Flexible Residues**”→“**Input**”→“**Choose Macromolecule**”→选中当前的蛋白质的文件名→“**Select Molecule**”；在左侧DashBoard中选中需要设置为柔性的残基，重新点击工具栏“**Flexible Residues**”→“**Choose Torsions in Currently Selected Residues...**”→“**Close**”，再依次点击“**Flexible Residues**”→“**Output**”→“**Save Flexible PDBQT...**”，将残基信息保存为`1hsg_receptor_flex.pdbqt`。

完成柔性残基的设置后需要将其余的残基均设置为刚性，在DashBoard中选中除刚设置的柔性残基外的所有残基，点击工具栏“**Flexible Residues**”→“**Output”→“Save Rigid PDBQT...**”，将剩余残基全部信息保存为`1hsg_receptor_rigid.pdbqt`。（在测试过程中发现***V1.5.7***版本貌似处理柔性残基会闪退，如果确实需要设置柔性，可以尝试[ADFR](https://ccsb.scripps.edu/adfr/downloads/)，一个专门用于Autodock Flexible Receptor的软件，推荐在Linux下安装，具体安装过程请查看官网。）

* 采用ADFR Suite中的`prepare_receptor`的命令对蛋白质进行加氢，并定义柔性残基:
```
prepare_receptor -r 1hsg.pdb -o 1hsg.pdbqt
pythonsh /your path/prepare_flexreceptor.py -r 1hsg.pdbqt -s THR315
```
其中，`-s`定义的是柔性残基的编号，如果需要选择多个残基，则需要用下划线相连，例如：`-s THR315_GLU316_PHE317`。


